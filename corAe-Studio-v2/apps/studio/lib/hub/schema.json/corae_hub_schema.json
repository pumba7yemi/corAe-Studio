{
  "entity": "corae_hub_deal",
  "version": "1.0",
  "modes": [
    "BUYER",
    "SELLER",
    "BROKER"
  ],
  "stages": [
    "ORDER",
    "BOOKING",
    "ACTIVE",
    "REPORTING",
    "INVOICING"
  ],
  "principles": {
    "pricelock_chain": true,
    "corae_confirmed": true,
    "big_nine_enforced": true
  },
  "big_nine": [
    "signed_tcs",
    "binding_quote",
    "required_documents",
    "contact_product_site_details",
    "geographical_pricing",
    "ops_docs_complete",
    "booking_compliance",
    "order_execution",
    "reporting_and_remittance"
  ],
  "entities": {
    "Deal": {
      "keys": [
        "id",
        "code"
      ],
      "fields": {
        "id": {
          "type": "string",
          "format": "cuid"
        },
        "code": {
          "type": "string",
          "description": "Human-friendly deal code, e.g., BTDO-2025-0001"
        },
        "mode": {
          "type": "string",
          "enum": [
            "BUYER",
            "SELLER",
            "BROKER"
          ]
        },
        "stage": {
          "type": "string",
          "enum": [
            "ORDER",
            "BOOKING",
            "ACTIVE",
            "REPORTING",
            "INVOICING"
          ],
          "default": "ORDER"
        },
        "createdAt": {
          "type": "string",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time"
        },
        "priceLockedAt": {
          "type": "string",
          "format": "date-time",
          "nullable": true
        },
        "confirmedAt": {
          "type": "string",
          "format": "date-time",
          "nullable": true
        },
        "statusFlags": {
          "type": "object",
          "properties": {
            "pricelock": {
              "type": "string",
              "enum": [
                "Locked",
                "Pending",
                "Breached"
              ]
            },
            "confirmed": {
              "type": "boolean"
            }
          }
        },
        "vendorId": {
          "type": "string"
        },
        "clientId": {
          "type": "string"
        },
        "currency": {
          "type": "string",
          "examples": [
            "AED",
            "USD",
            "GBP"
          ]
        },
        "creditTerms": {
          "type": "string",
          "nullable": true
        },
        "vatPercent": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        },
        "discountPct": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        },
        "deliveryBranch": {
          "type": "string",
          "nullable": true
        },
        "deliverySlotIso": {
          "type": "string",
          "format": "date-time",
          "nullable": true
        },
        "logisticsNotes": {
          "type": "string",
          "nullable": true
        },
        "cashPlan": {
          "type": "object",
          "nullable": true
        },
        "exchangeRate": {
          "type": "number",
          "nullable": true
        },
        "subtotal": {
          "type": "number"
        },
        "vatAmount": {
          "type": "number"
        },
        "total": {
          "type": "number"
        },
        "bigNine": {
          "type": "object",
          "properties": {
            "signed_tcs": {
              "type": "boolean"
            },
            "binding_quote": {
              "type": "boolean"
            },
            "required_documents": {
              "type": "boolean"
            },
            "contact_product_site_details": {
              "type": "boolean"
            },
            "geographical_pricing": {
              "type": "boolean"
            },
            "ops_docs_complete": {
              "type": "boolean"
            },
            "booking_compliance": {
              "type": "boolean"
            },
            "order_execution": {
              "type": "boolean"
            },
            "reporting_and_remittance": {
              "type": "boolean"
            }
          }
        },
        "meta": {
          "type": "object",
          "description": "Free-form extensions to avoid data loss"
        }
      },
      "relations": {
        "items": {
          "type": "DealItem[]"
        },
        "documents": {
          "type": "Document[]"
        },
        "payments": {
          "type": "Payment[]"
        },
        "deliveries": {
          "type": "Delivery[]"
        },
        "audits": {
          "type": "AuditEvent[]"
        }
      }
    },
    "DealItem": {
      "fields": {
        "id": {
          "type": "string",
          "format": "cuid"
        },
        "dealId": {
          "type": "string"
        },
        "sku": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "category": {
          "type": "string",
          "nullable": true
        },
        "brand": {
          "type": "string",
          "nullable": true
        },
        "uom": {
          "type": "string"
        },
        "qty": {
          "type": "number"
        },
        "unitPrice": {
          "type": "number"
        },
        "expiryDate": {
          "type": "string",
          "format": "date",
          "nullable": true
        }
      }
    },
    "Party": {
      "fields": {
        "id": {
          "type": "string",
          "format": "cuid"
        },
        "kind": {
          "type": "string",
          "enum": [
            "Vendor",
            "Client"
          ]
        },
        "name": {
          "type": "string"
        },
        "taxId": {
          "type": "string",
          "nullable": true
        },
        "address": {
          "type": "string",
          "nullable": true
        },
        "contact": {
          "type": "object",
          "nullable": true
        }
      }
    },
    "Document": {
      "fields": {
        "id": {
          "type": "string",
          "format": "cuid"
        },
        "dealId": {
          "type": "string"
        },
        "kind": {
          "type": "string",
          "enum": [
            "QUOTE",
            "BTDO",
            "BDO",
            "PO",
            "GRN",
            "INVOICE",
            "REPORT",
            "OTHER"
          ]
        },
        "url": {
          "type": "string"
        },
        "meta": {
          "type": "object",
          "nullable": true
        },
        "createdAt": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "Delivery": {
      "fields": {
        "id": {
          "type": "string",
          "format": "cuid"
        },
        "dealId": {
          "type": "string"
        },
        "slotIso": {
          "type": "string",
          "format": "date-time"
        },
        "mode": {
          "type": "string",
          "enum": [
            "vendor_delivery",
            "pickup",
            "courier"
          ]
        },
        "conditions": {
          "type": "string",
          "nullable": true
        },
        "grnUrl": {
          "type": "string",
          "nullable": true
        }
      }
    },
    "Payment": {
      "fields": {
        "id": {
          "type": "string",
          "format": "cuid"
        },
        "dealId": {
          "type": "string"
        },
        "method": {
          "type": "string",
          "enum": [
            "cash",
            "bank",
            "credit"
          ]
        },
        "amount": {
          "type": "number"
        },
        "scheduledOn": {
          "type": "string",
          "format": "date-time",
          "nullable": true
        },
        "paidOn": {
          "type": "string",
          "format": "date-time",
          "nullable": true
        },
        "reference": {
          "type": "string",
          "nullable": true
        }
      }
    },
    "AuditEvent": {
      "fields": {
        "id": {
          "type": "string",
          "format": "cuid"
        },
        "dealId": {
          "type": "string"
        },
        "actor": {
          "type": "string"
        },
        "action": {
          "type": "string",
          "enum": [
            "CREATE_BTDO",
            "CONFIRM_BDO",
            "ISSUE_PO",
            "POST_GRN",
            "ISSUE_INVOICE",
            "RE_BROKER"
          ]
        },
        "before": {
          "type": "object",
          "nullable": true
        },
        "after": {
          "type": "object",
          "nullable": true
        },
        "createdAt": {
          "type": "string",
          "format": "date-time"
        }
      }
    }
  },
  "guards": {
    "toBOOKING": [
      "statusFlags.pricelock == 'Locked'",
      "bigNine.signed_tcs",
      "bigNine.binding_quote"
    ],
    "toACTIVE": [
      "documents contains 'PO'",
      "deliverySlotIso != null"
    ],
    "toREPORTING": [
      "documents contains 'GRN' OR 'REPORT'"
    ],
    "toINVOICING": [
      "documents contains 'INVOICE'",
      "bigNine.reporting_and_remittance"
    ]
  }
}
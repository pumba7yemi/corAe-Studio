// ────────────────────────────────────────────────
// corAe Facilities Register™ — Sites, Assets & Maintenance
// File: apps/studio/prisma/schema/facilities-register.prisma
// ────────────────────────────────────────────────
// Depends on: core-company.prisma, chrono-workflow.prisma, hr-role.prisma, workflow-agent.prisma
// Purpose: Track locations, fixed assets, maintenance plans, work orders, and service contracts.
// ────────────────────────────────────────────────

enum FacilityType {
  HQ
  WAREHOUSE
  STORE
  OFFICE
  PLANT
  OTHER
}

enum AssetType {
  EQUIPMENT
  VEHICLE
  IT
  FURNITURE
  UTILITY
  OTHER
}

enum AssetStatus {
  ACTIVE
  IN_SERVICE
  OUT_OF_SERVICE
  DISPOSED
}

enum WorkOrderStatus {
  DRAFT
  SCHEDULED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum WorkPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum MaintenanceType {
  PREVENTIVE
  CORRECTIVE
  PREDICTIVE
  INSPECTION
  INSTALLATION
}

enum ContractStatus {
  ACTIVE
  PENDING
  SUSPENDED
  EXPIRED
  TERMINATED
}

model Facility {
  id            String           @id @default(cuid())
  companyId     String
  code          String           @unique
  name          String
  type          FacilityType     @default(OTHER)
  addressLine1  String?
  addressLine2  String?
  city          String?
  stateRegion   String?
  country       String?
  geoLat        Decimal?         @db.Decimal(10,6)
  geoLng        Decimal?         @db.Decimal(10,6)
  contactName   String?
  contactPhone  String?
  notes         String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  company       CompanyIdentity  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  assets        Asset[]
  contracts     ServiceContract[]
}

model Asset {
  id              String           @id @default(cuid())
  companyId       String
  facilityId      String?
  tag             String           @unique
  type            AssetType        @default(OTHER)
  name            String
  manufacturer    String?
  model           String?
  serialNumber    String?
  purchaseDate    DateTime?
  purchaseCost    Decimal?         @db.Decimal(14,4)
  warrantyUntil   DateTime?
  status          AssetStatus      @default(ACTIVE)
  specs           Json?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  company         CompanyIdentity  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  facility        Facility?        @relation(fields: [facilityId], references: [id])
  plans           MaintenancePlan[]
  meters          MeterReading[]
  workOrders      WorkOrder[]      @relation("AssetWorkOrders")
  documents       AssetDocument[]
}

model AssetDocument {
  id          String   @id @default(cuid())
  assetId     String
  label       String?
  url         String
  mimeType    String?
  bytes       Int?
  uploadedAt  DateTime @default(now())

  asset       Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
}

model MaintenancePlan {
  id              String           @id @default(cuid())
  companyId       String
  assetId         String?
  facilityId      String?
  title           String
  maintenanceType MaintenanceType  @default(PREVENTIVE)
  intervalDays    Int?             // e.g., every 90 days
  intervalMeter   Int?             // e.g., every 5,000 km/hours
  sopUrl          String?
  active          Boolean          @default(true)
  lastScheduledAt DateTime?
  nextDueAt       DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  company         CompanyIdentity   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  asset           Asset?            @relation(fields: [assetId], references: [id])
  facility        Facility?         @relation(fields: [facilityId], references: [id])
  workOrders      WorkOrder[]       @relation("PlanWorkOrders")
}

model WorkOrder {
  id              String           @id @default(cuid())
  companyId       String
  title           String
  description     String?
  status          WorkOrderStatus  @default(DRAFT)
  priority        WorkPriority     @default(MEDIUM)
  maintenanceType MaintenanceType  @default(CORRECTIVE)
  facilityId      String?
  assetId         String?
  planId          String?
  requestedById   String?          // HrRole or partner requester (store HrRole.id)
  assignedToId    String?          // HrRole technician/ops
  agentId         String?          // WorkflowAgent handling automation
  scheduledAt     DateTime?
  startedAt       DateTime?
  completedAt     DateTime?
  cancellationNote String?
  costParts       Decimal?         @db.Decimal(14,4)
  costLabor       Decimal?         @db.Decimal(14,4)
  costOther       Decimal?         @db.Decimal(14,4)
  podUrl          String?          // proof of delivery/completion
  chronoEventId   String?          // last event touch
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  company         CompanyIdentity  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  facility        Facility?        @relation(fields: [facilityId], references: [id])
  asset           Asset?           @relation("AssetWorkOrders", fields: [assetId], references: [id])
  plan            MaintenancePlan? @relation("PlanWorkOrders", fields: [planId], references: [id])
  requestedBy     HrRole?          @relation("WORequestedBy", fields: [requestedById], references: [id])
  assignedTo      HrRole?          @relation("WOAssignedTo", fields: [assignedToId], references: [id])
  agent           WorkflowAgent?   @relation(fields: [agentId], references: [id])
  chronoEvent     ChronoEvent?     @relation(fields: [chronoEventId], references: [id])

  parts           WorkPart[]
  notes           WorkNote[]

  @@index([companyId, status, priority])
  @@index([facilityId])
  @@index([assetId])
  @@index([planId])
}

model WorkPart {
  id          String    @id @default(cuid())
  workOrderId String
  skuCode     String
  name        String?
  qty         Decimal   @db.Decimal(12,3)
  unitCost    Decimal   @db.Decimal(12,4)
  lineTotal   Decimal   @db.Decimal(14,4)

  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
}

model WorkNote {
  id          String    @id @default(cuid())
  workOrderId String
  authorId    String?   // HrRole.id or agent id (store string)
  authorName  String?
  note        String
  createdAt   DateTime  @default(now())

  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId, createdAt])
}

model MeterReading {
  id          String    @id @default(cuid())
  assetId     String
  reading     Decimal   @db.Decimal(14,3)
  unit        String    @default("KM") // KM | HOURS | KWH | CUSTOM
  readAt      DateTime  @default(now())
  source      String?   // manual | IoT | import
  note        String?

  asset       Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId, readAt])
}

model ServiceContract {
  id            String           @id @default(cuid())
  companyId     String
  facilityId    String?
  providerName  String
  contractNo    String?          @unique
  startDate     DateTime?
  endDate       DateTime?
  status        ContractStatus   @default(ACTIVE)
  scope         String?          // brief scope/coverage
  contactName   String?
  contactEmail  String?
  contactPhone  String?
  slaMinutes    Int?             // expected response time
  annualCost    Decimal?         @db.Decimal(14,4)
  renewalAgentId String?         // WorkflowAgent for auto-renew reminders
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  company       CompanyIdentity  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  facility      Facility?        @relation(fields: [facilityId], references: [id])
  renewalAgent  WorkflowAgent?   @relation(fields: [renewalAgentId], references: [id])
}
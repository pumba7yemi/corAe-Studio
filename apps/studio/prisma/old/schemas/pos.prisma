/* ============================================================
   corAe POS — OBARI-integrated Stock, Sales & Loyalty Engine
   Structure: Item → StockState → FlowEvent → Sale → Finance
   ============================================================ */

enum FlowDirection {
  IN
  OUT
}

enum SaleStatus {
  PENDING
  COMPLETED
  REFUNDED
  CANCELLED
}

/* ------------ Core Products ------------ */
model Item {
  id        String      @id @default(cuid())
  code      String      @unique
  name      String
  barcode   String?     @unique
  imageUrl  String?
  category  String?
  price     Decimal     @db.Decimal(12,2) @default(0)
  taxRate   Decimal?    @db.Decimal(5,2)
  isActive  Boolean     @default(true)

  stock     StockState?
  flowEvents FlowEvent[]
  saleLines SaleLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/* ------------ Stock State ------------ */
model StockState {
  id        String   @id @default(cuid())
  itemId    String   @unique
  item      Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  onHand    Decimal  @db.Decimal(14,3) @default(0)
  lastSync  DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/* ------------ Flow Events (movement) ------------ */
model FlowEvent {
  id          String         @id @default(cuid())
  itemId      String
  item        Item           @relation(fields: [itemId], references: [id], onDelete: Cascade)
  stage       String          // "ORDER" | "DELIVERY" | "SALE" | "ADJUSTMENT"
  direction   FlowDirection
  qty         Decimal         @db.Decimal(14,3)
  sourceRef   String?         // BDO code, OBARI booking, etc.
  createdAt   DateTime        @default(now())
}

/* ------------ Sales ------------ */
model Sale {
  id           String      @id @default(cuid())
  status       SaleStatus  @default(COMPLETED)
  total        Decimal     @db.Decimal(14,2) @default(0)
  currency     String      @default("AED")
  paymentType  String?     // "CASH" | "CARD" | "MIXED"
  terminalId   String?
  loyaltyCode  String?

  lines        SaleLine[]
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

model SaleLine {
  id          String   @id @default(cuid())
  saleId      String
  sale        Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  itemId      String
  item        Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  qty         Decimal  @db.Decimal(14,3) @default(1)
  unitPrice   Decimal  @db.Decimal(12,2) @default(0)
  lineTotal   Decimal  @db.Decimal(14,2) @default(0)

  createdAt   DateTime @default(now())
}

/* ------------ Tax + Pricing ------------ */
model PriceRule {
  id        String   @id @default(cuid())
  code      String   @unique
  title     String
  discountPc Decimal? @db.Decimal(6,3)
  validFrom DateTime?
  validTo   DateTime?
  createdAt DateTime @default(now())
}

model TaxRule {
  id        String   @id @default(cuid())
  code      String   @unique
  rate      Decimal  @db.Decimal(5,2)
  region    String?
  createdAt DateTime @default(now())
}

/* ------------ Loyalty (Voucher / Cashback) ------------ */
model LoyaltyVoucher {
  id          String   @id @default(cuid())
  code        String   @unique
  value       Decimal  @db.Decimal(10,2)
  minSpend    Decimal? @db.Decimal(10,2)
  expiresAt   DateTime?
  redeemed    Boolean  @default(false)
  redeemedAt  DateTime?
  saleId      String?
  sale        Sale?    @relation(fields: [saleId], references: [id], onDelete: SetNull)

  createdAt   DateTime @default(now())
}
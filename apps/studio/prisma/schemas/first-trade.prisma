// ────────────────────────────────────────────────
// corAe First Trade™ — Company Formation & First Deal Core
// File: apps/studio/prisma/schema/first-trade.prisma
// ────────────────────────────────────────────────
// Depends on: core-company.prisma (CompanyIdentity)
// Purpose: governs setup, first trade execution, and HR / OBARI transition
// Note: Your root schema.prisma should define datasource/generator and include this fragment.
// ────────────────────────────────────────────────

//// ───────── Enums ─────────
enum FirstDealMode {
  survey
  visit
}

enum PartyType {
  vendor
  customer
}

enum PricingModel {
  A_PLUS_X
  FIXED
}

enum FirstDealStatus {
  draft
  proposed
  approved
  active
  cancelled
}

enum BdoStage {
  ORDER
  SHIPMENT
  INVOICE
  CLOSED
}

//// ───────── Models ─────────

model CompanyRole {
  id        String  @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyId String
  key       String
  ownerLed  Boolean @default(true)
  aiAgent   String?

  company   CompanyIdentity @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, key])
}

model FirstDeal {
  id           String          @id @default(cuid())
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  companyId    String
  mode         FirstDealMode   // survey | visit
  partyType    PartyType       // vendor | customer
  partyName    String

  pricingModel PricingModel    // A+X | fixed
  skuSet       String[]        // Postgres: text[]

  status       FirstDealStatus @default(draft)

  company      CompanyIdentity @relation(fields: [companyId], references: [id], onDelete: Cascade)
  bdoRecords   BdoRecord[]

  @@index([companyId, status, createdAt])
}

model BdoRecord {
  id            String    @id @default(cuid())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  dealId        String
  reference     String    @unique
  stage         BdoStage  @default(ORDER) // mirrors OBARI stage
  issuedDate    DateTime  @default(now())
  remarks       String?
  autoGenerated Boolean   @default(false)

  deal          FirstDeal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId, stage, issuedDate])
}

model HrFile {
  id            String          @id @default(cuid())
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  companyId     String
  visaQuota     Int?
  fileNumber    String?
  registeredAt  DateTime?
  approved      Boolean         @default(false)

  company       CompanyIdentity @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, approved])
}

model UploadRecord {
  id         String          @id @default(cuid())
  createdAt  DateTime        @default(now())

  companyId  String
  category   String          // licence | ejari | vat | vendors | customers | staff
  fileUrl    String

  company    CompanyIdentity @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, category, createdAt])
}